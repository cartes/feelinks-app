{% extends "base_dashboard.html" %}
{% block title %}Editar perfil | feelinks.app{% endblock %}
{% block header %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
{% include "components/modals/modal_avatar.html" %}

    <div class="flex-1 flex-row flex">
        <div class="flex-col space-y-4 p-6 w-2/3">
            <h1 class="text-2xl font-bold mb-6">Editar perfil</h1>

            <form method="POST" class="grid gap-6 max-w-2xl" id="profile-form" enctype="multipart/form-data">
                {% csrf_token %}

                <div>
                    <label class="block mb-1 text-sm font-medium">Avatar (URL)</label>
                    {% if profile.avatar %}
                        <img src="{{ profile.avatar.url }}"
                             alt="Avatar"
                             id="avatarImage"
                             class="w-24 h-24 mx-auto rounded-full border object-cover cursor-pointer hover:opacity-80 transition"
                             data-modal-target="avatarModal"
                             data-modal-toggle="avatarModal">

                    {% endif %}
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium">Nombre para mostrar</label>
                    {{ form.display_name }}
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium">Biografía</label>
                    {{ form.bio }}
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium">Tema</label>
                    {{ form.theme }}
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium">Tipografía</label>
                    {{ form.font_family }}
                </div>


                <div id="customColors" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium">Fondo</label>
                        {{ form.background_color }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Texto</label>
                        {{ form.text_color }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Principal</label>
                        {{ form.primary_color }}
                    </div>
                </div>

                <div class="flex items-center mt-4">
                    <input type="checkbox" name="show_invite_footer" id="show_invite_footer"
                           class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                           {% if profile.show_invite_footer %}checked{% endif %}>
                    <label for="show_invite_footer" class="ml-2 text-sm font-medium text-gray-900">
                        Mostrar pie de página con invitación a feelinks.app
                    </label>
                </div>

                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Guardar</button>
            </form>

        </div>

        <div class="flex-col border-l p-6 w-1/3 min-w-[375px]">
            <!-- Vista previa -->
            <div class="mt-10 pt-6">
                <h2 class="text-lg font-semibold mb-2">Vista previa</h2>
                <div class="flex justify-center">
                    <div class="w-[280px] h-[580px] rounded-[2.5rem] border-4 border-gray-300 bg-white shadow-lg overflow-hidden flex flex-col justify-start p-4"
                         id="previewBox"
                         style="background-color: {{ request.user.profile.background_color }}; color: {{ request.user.profile.text_color }};">
                        <img id="previewAvatar"
                             src="{{ request.user.profile.avatar.url }}"
                             class="w-20 h-20 mx-auto rounded-full mb-3 border object-cover"/>
                        <h3 class="text-center text-sm font-bold">
                            {{ request.user.profile.display_name|default:request.user.username }}
                        </h3>
                        <p class="text-center text-sm mt-1">
                            {{ request.user.profile.bio }}
                        </p>

                        <a href="#"
                           id="previewButton"
                                {% if request.user.profile.theme != 'custom' %}
                           class="inline-block mt-6 px-4 py-2 mx-auto rounded text-center text-xs {% else %}
                           class="inline-block mt-6 px-4 py-2 mx-auto rounded text-white text-center text-sm
                                    " {% endif %}
                        {% if request.user.profile.theme != 'custom' %}
                            {% if request.user.profile.theme == 'dark' %}
                                bg-gray-900 text-white"
                            {% elif request.user.profile.theme == 'neon' %}
                                bg-black text-green-400"
                            {% elif request.user.profile.theme == 'light' %}
                                bg-white text-gray-800"
                            {% endif %}
                        {% else %}
                            style="color: inherit; background-color: {{ request.user.profile.primary_color }}; color:
                            {{ request.user.profile.text_color }};"
                        {% endif %}
                        >
                        Enlace de ejemplo
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const themes = {
            claro: {
                background: "#ffffff",
                text: "#000000",
                primary: "#2563eb"
            },
            oscuro: {
                background: "#1f2937",
                text: "#f9fafb",
                primary: "#3b82f6"
            },
            neon: {
                background: "#0f0f0f",
                text: "#39ff14",
                primary: "#ff00ff"
            }
        };

        const themeSelect = document.getElementById("id_theme");
        const backgroundInput = document.getElementById("id_background_color");
        const textInput = document.getElementById("id_text_color");
        const primaryInput = document.getElementById("id_primary_color");
        const previewBox = document.getElementById("previewBox");
        const previewButton = document.getElementById("previewButton");
        const fontSelect = document.getElementById("id_font_family");
    </script>

    <script>
        function applyPreviewStyles(bg, text, primary) {
            previewBox.style.backgroundColor = bg;
            previewBox.style.color = text;
            previewButton.style.backgroundColor = primary;
        }

        function updatePreview() {
            const selectedTheme = themeSelect.value;

            if (themes[selectedTheme]) {
                const {background, text, primary} = themes[selectedTheme];

                // aplicar tema predefinido
                backgroundInput.value = background;
                textInput.value = text;
                primaryInput.value = primary;
                backgroundInput.disabled = true;
                textInput.disabled = true;
                primaryInput.disabled = true;

                applyPreviewStyles(background, text, primary);
            } else {
                // tema personalizado
                backgroundInput.disabled = false;
                textInput.disabled = false;
                primaryInput.disabled = false;

                applyPreviewStyles(
                    backgroundInput.value,
                    textInput.value,
                    primaryInput.value
                );
            }

            updateFontPreview(); // mantiene la fuente actualizada
        }

        function updateFontPreview() {
            const currentFont = Array.from(previewBox.classList).find(c => c.startsWith("font-"));
            if (currentFont) previewBox.classList.remove(currentFont);
            previewBox.classList.add("font-" + fontSelect.value);
        }

        // Eventos
        themeSelect.addEventListener("change", updatePreview);
        fontSelect.addEventListener("change", updateFontPreview);

        backgroundInput.addEventListener("input", updatePreview);
        textInput.addEventListener("input", updatePreview);
        primaryInput.addEventListener("input", updatePreview);

        // Ejecutar al cargar
        document.addEventListener("DOMContentLoaded", () => {
            updatePreview();
        });

    </script>

{% endblock %}
